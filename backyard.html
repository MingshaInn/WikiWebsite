<!doctype html>
<html>
    <head>    
        <meta charset="utf-8">
        <title>鸣沙客栈 Wiki | 后院</title>
        <link href="https://cdn.jsdelivr.net/gh/akottr/dragtable@master/dragtable.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
        <link href="https://unpkg.com/jquery-resizable-columns@0.2.3/dist/jquery.resizableColumns.css" rel="stylesheet" crossorigin="anonymous">
        <link href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css" rel="stylesheet" crossorigin="anonymous">
        <link href="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/sticky-header/bootstrap-table-sticky-header.css" rel="stylesheet" crossorigin="anonymous">
        <link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" crossorigin="anonymous">
    </head>
    <body>
        <header>
            <nav class="navbar navbar-light bg-light"> 
                <a class="navbar-brand" href="./index.html">
                    <img src="./res/img/ic_launcher.png" width="30" height="30" class="d-inline-block align-top" alt="">
                    鸣沙客栈 Wiki
                </a>
                <div class="nav-item"><a class="nav-link text-dark" href="#">人物</a></div>
                <div class="nav-item"><a class="nav-link text-dark" href="#">建筑</a></div>
                <div class="nav-item"><a class="nav-link text-dark" href="./kitchen.html">后厨</a></div>
                <div class="nav-item"><a class="nav-link text-dark font-weight-bold" href="./backyard.html">后院</a></div>
                <div class="nav-item"><a class="nav-link text-dark" href="#">成就</a></div>
                <div class="nav-item"><a class="nav-link text-dark" href="#">常见问题</a></div>
                <div class="nav-item"><a class="nav-link text-dark" href="#download">版本号 2.1.8</a></div>
            </nav>
        </header>
        <section>
            <div class="list-group float-left fix-sticky col-1" role="tablist">
                <a class="list-group-item list-group-item-action active text-center" href="#product" role="tab" data-toggle="list" aria-controls="product" id="list-product">作物</a>
                <a class="list-group-item list-group-item-action text-center" href="#seed" role="tab" data-toggle="list" aria-controls="seed" id="list-seed">种子</a>
            </div>
            <div class="tab-content container">
                <figure id="product" class="tab-pane fade show active bootstrap-table bootstrap4" role="tabpanel" aria-labelledby="list-product">
                    <table id="ptable"
                    class="table"
                    data-toggle="table"
                    data-show-columns-toggle-all="true"
                    data-show-columns="true"
                    data-show-fullscreen="true"
                    data-search="true"
                    data-resizable="true"
                    data-sticky-header="true"
                    data-response-handler="product_handler" 
                    data-url="res/db/products.json"
                    data-reorderable-columns="true"
                    min-width="400em">
                        <thead class="thead-light sticky-header">
                            <tr>
                                <th data-sortable="true" data-switchable="false" data-field="ID" data-title="ID"></th>
                                <th data-sortable="true" data-field="Name" data-title="名称"></th>
                                <th data-sortable="true" data-field="Didian" data-title="位置"></th>
                                <th data-sortable="true" data-field="Miaoshu1" data-title="描述"></th>
                                <th data-sortable="true" data-field="a_seed" data-title="种子"></th>
                                <th data-sortable="true" data-field="Jijie" data-title="时令"></th>
                                <th data-sortable="true" data-sorter="time_sort" data-field="on-season-time" data-title="应季成熟时间"></th>
                                <th data-sortable="true" data-sorter="time_sort" data-field="off-season-time" data-title="反季成熟时间"></th>
                                <th data-sortable="true" data-field="Chanliang" data-title="应季产量"></th>
                                <th data-sortable="true" data-field="FanjiCL" data-title="反季产量"></th>
                                <th data-sortable="true" data-field="Level" data-title="最低生产等级"></th>
                                <th data-field="probability" data-title="概率情况"></th>
                                <th data-sortable="true" data-field="Shouchujia" data-title="作物价格"></th>
                            </tr>
                        </thead>
                    </table>
                </figure>
                <figure id="seed" class="tab-pane fade" role="tabpanel" aria-labelledby="list-seed">
                    <table id="stable"
                    class="table"
                    data-toggle="table"
                    data-detail-view="true"
                    data-show-columns-toggle-all="true"
                    data-show-columns="true"
                    data-show-fullscreen="true"
                    data-search="true"
                    data-resizable="true"
                    data-detail-formatter="subtable"
                    data-sticky-header="true"
                    data-response-handler="seed_handler" 
                    data-url="res/db/products.json"
                    data-reorderable-columns="true"
                    min-width="400em">
                        <thead class="thead-light">
                            <tr>
                                <th data-sortable="true" data-switchable="false" data-field="id" data-title="ID"></th>
                                <th data-sortable="true" data-field="name" data-title="名称"></th>
                                <th data-sortable="true" data-field="location" data-title="位置"></th>
                                <th data-sortable="true" data-field="describe" data-title="描述"></th>
                                <th data-sortable="true" data-field="provide" data-title="获取方式"></th>
                                <th data-sortable="true" data-field="exchange" data-title="可兑换性"></th>
                                <th data-sortable="true" data-sorter="time_sort" data-field="least-harvest-time" data-title="最短成熟时间"></th>
                                <th data-sortable="true" data-sorter="time_sort" data-field="most-harvest-time" data-title="最长成熟时间"></th>
                                <th data-sortable="true" data-field="level" data-title="最低生产等级"></th>
                                <th data-sortable="true" data-field="price" data-title="种子价格"></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </figure>
            </div>
        </section>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/jqueryui@1.11.1/jquery-ui.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/akottr/dragtable@master/jquery.dragtable.js"></script>
        <script src="https://unpkg.com/jquery-resizable-columns@0.2.3/dist/jquery.resizableColumns.min.js" type="text/javascript" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js" type="text/javascript" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/resizable/bootstrap-table-resizable.min.js" type="text/javascript" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.js" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/reorder-columns/bootstrap-table-reorder-columns.min.js" crossorigin="anonymous"></script>
        <script>
            function time_sort(a, b) {
                return string_long(a) - string_long(b)
            }

            function string_long(a) {
                let numbers = a.split(/h|ms|m|s/)
                let h = 0
                let m = 0
                let ms = 0
                let s = 0
                if (!a.includes("h")) {
                    numbers.splice(0,0,"0")
                } 
                if (!a.includes("m") || (a.indexOf("m") == a.indexOf("ms"))) {
                    numbers.splice(1,0,"0")
                }
                if (!a.includes("s") || (a.indexOf("s") == a.indexOf("ms") + 1)) {
                    numbers.splice(2,0,"0")
                }
                if (!a.includes("ms")) {
                    numbers.splice(3,0,"0")
                }
                return parseInt(numbers[0]) * 3600 + parseInt(numbers[1]) * 60 + parseInt(numbers[2]) + parseFloat(numbers[3]) / 1000
            }

            function exchange_str(id, name, num) {
                return id === "无" ? "不可兑换" : "可被 "+num+" 个"+ name +"兑换"
            }

            function get_product_name(json, id) {
                let ret = ""
                $.each(json, function(no, info) {
                    if (id === info["ID"]) ret = info['Name'] 
                })
                return ret
            }

            function format_time(integer) {
                let h = Math.floor(integer / 3600)
                let m = Math.floor(integer % 3600 / 60)
                let ts = integer % 60
                s = Math.floor(ts)
                let ms = (ts - s) * 1000
                let ret = ""
                if (h !== 0) ret += (h + "h")
                if (m !== 0) ret += (m + "m")
                if (s !== 0) ret += (s + "s")
                if (ms !== 0) ret += (ms + "ms")
                return ret
            }

            function probability_str(info) {
                let location = info["Didian"]
                let impossible_str = "无法种出"
                let absolute_str = "必定种出"
                let ret = ""
                for (let i = 1; i <= 6; i++) {
                    ret += i + " 级" + location + ": "
                    if (i < info["Level"]) {
                        ret += impossible_str + "<br>" 
                        continue
                    }
                    if (info["Gailv"+i+"c"] === 1 && info["Gailv"+i+"x"] === 1 && info["Gailv"+i+"q"] === 1 && info["Gailv"+i+"d"] === 1) {
                        ret += absolute_str + '<br>' 
                        continue
                    }
                    ret += "春(" + (info["Gailv"+i+"c"] * 100) +"%), 夏(" + (info["Gailv"+i+"x"] * 100) +"%), 秋(" + (info["Gailv"+i+"q"] * 100) +"%), 冬(" + (info["Gailv"+i+"d"]  * 100) +"%) <br>" 
                }

                ret = ret.substring(0, ret.length-4)

                return ret
            }

            function describe(location, level, d1, d2, d3) {
                let cnt = level
                let = ret = level + " 级"+location+": "+ d1 + "<br>"
                if (d2 !== "无") ret += (++level) + " 级"+location+": "+ d2 + "<br>"
                if (d3 !== "无") ret += (++level) + " 级"+location+": "+ d3 + "<br>"
                return ret.substring(0, ret.length-4)
            }

            function product_with_seed(json, id, index)  {
                let p = {}

                $.each(json, function(no, info){
                    if (info["SeedID"] === id) {
                        p[info["Name"]] = {
                            "spring": info["Gailv"+ index +"c"],
                            "summer": info["Gailv"+ index +"x"],
                            "autumn": info["Gailv"+ index +"q"],
                            "winter": info["Gailv"+ index +"d"],
                            "on-season": info["Chanliang"],
                            "off-season": info["FanjiCL"]
                        }
                    }
                })

                let ret = {}
                ret["spring"] = {}
                ret["summer"] = {}
                ret["autumn"] = {}
                ret["winter"] = {}
                ret["on-season"] = {}
                ret["off-season"] = {}

                $.each(p, function(key, value) {
                    ret["spring"][key] = (value["spring"] * 100) + "%"
                    ret["summer"][key] = (value["summer"] * 100) + "%"
                    ret["autumn"][key] = (value["autumn"] * 100) + "%"
                    ret["winter"][key] = (value["winter"] * 100) + "%"
                    ret["on-season"][key] = (value["spring"] == 0 && value["summer"] == 0 && value["autumn"] == 0 && value["winter"] == 0) ? 0 : value["on-season"]
                    ret["off-season"][key] = (value["spring"] == 0 && value["summer"] == 0 && value["autumn"] == 0 && value["winter"] == 0) ? 0 : value["off-season"]
                })

                let spring = ""
                $.each(ret["spring"], function(key, value) {
                    spring += "<p>" + key + ": " + value + "</p>"
                })

                let summer = ""
                $.each(ret["summer"], function(key, value) {
                    summer += "<p>" + key + ": " + value + "</p>"
                })

                let autumn = ""
                $.each(ret["autumn"], function(key, value) {
                    autumn += "<p>" + key + ": " + value + "</p>"
                })

                let winter = ""
                $.each(ret["winter"], function(key, value) {
                    winter += "<p>" + key + ": " + value + "</p>"
                })

                let on = ""
                $.each(ret["on-season"], function(key, value) {
                    on += "<p>" + key + ": " + value + "</p>"
                })

                let off = ""
                $.each(ret["off-season"], function(key, value) {
                    off += "<p>" + key + ": " + value + "</p>"
                })

                return '<td>'+on+'</td><td>'+off+'</td><td>'+spring+'</td><td>'+summer+'</td><td>'+autumn+'</td><td>'+winter+'</td>'
            }

            var raw = {}

            function product_handler(data) {
                let json = JSON.parse(JSON.stringify(data))["json"]
                raw = json
                let cnt = 0
                $.each(raw, function(no, info) {
                    info["prow"] = cnt
                    cnt++
                    info["a_seed"] = info["Zhongzi"]
                    info["on-season-time"] = format_time(info["Time"])
                    info["off-season-time"] = format_time(info["FanjiTime"])
                    info["on-season-quantity"] = info["Chanliang"]
                    info["probability"] = probability_str(info)
                })
                return raw
            }
            
            function seed_handler(data) {
                let json = JSON.parse(JSON.stringify(data))["json"]
                let tmp = []
                let cnt = 0
                $.each(json, function(no, info) {
                    if (info != undefined && !tmp.includes(info["SeedID"])) {
                        info["srow"] = cnt
                        cnt++
                        info["id"] = info["SeedID"]
                        info["name"] = info["Zhongzi"]
                        info["location"] = info["Didian"]
                        info["provide"] = info["Huode"]
                        info["level"] = info["Level"]
                        info["price"] = info["Zhongzijia"]
                        info["describe"] = describe(info["Didian"], info["Level"], info["Miaoshu2"], info["Miaoshu3"], info["Miaoshu4"])
                        info["exchange"] = exchange_str(info["Duihuan"], get_product_name(data["json"], info["Duihuan"]), info["DuihuanNum"])
                        info["least-harvest-time"] = format_time(info["XiangqingTimeX"] === "无" ? info["Time"] : info["XiangqingTimeX"])
                        info["most-harvest-time"] = format_time(info["XiangqingTimeS"] === "无" ? info["FanjiTime"] : info["XiangqingTimeS"])
                        tmp.push(info["SeedID"])
                    }
                })
                return json.filter(function(value, index, arr) {
                    return value["id"] !== undefined
                })
            }

            function subtable(index, row) {
                let l1='', l2='', l3='', l4='', l5='', l6=''

                if (row["Level"] == 3) {
                    l2 = '<td>2</td><td>'+ row["Name"] + ": " + 0 +'</td><td>' + row["Name"] + ": " + 0 + '</td><td colspan="4">'+ row["Name"] + ': 等级不足</td>'
                } else {
                    l2 = '<td>2</td>'+ product_with_seed(raw, row['SeedID'], 2)
                }

                if (row["Level"] >= 2) {
                    l1 = '<td>1</td><td>'+ row["Name"] + ": " + 0 +'</td><td>' + row["Name"] + ": " + 0 + '</td><td colspan="4">'+ row["Name"] + ': 等级不足</td>'
                } else {
                    l1 = '<td>1</td>'+ product_with_seed(raw, row['SeedID'], 1)
                }

                l3 = '<td>3</td>'+ product_with_seed(raw, row['SeedID'], 3)
                l4 = '<td>4</td>'+ product_with_seed(raw, row['SeedID'], 4)
                l5 = '<td>5</td>'+ product_with_seed(raw, row['SeedID'], 5)
                l6 = '<td>6</td>'+ product_with_seed(raw, row['SeedID'], 6)

                let construct = '<table class="table">'
                        + '<thead class="thead-light text-center">'
                        + '<tr>'
                            + '<th class="align-middle" rowspan="2">'+ row['Didian'] +'等级</th>'
                            + '<th class="align-middle" rowspan="2">最高产量</th>'
                            + '<th class="align-middle" rowspan="2">最低产量</th>'
                            + '<th class="align-middle" colspan="4">概率</th>'
                        + '</tr>'
                        + '<tr>'
                            + '<th class="align-middle">春</th>'
                            + '<th class="align-middle">夏</th>'
                            + '<th class="align-middle">秋</th>'
                            + '<th class="align-middle">冬</th>'
                        + '</tr>'
                        + '</thead><tbody>'
                        + '<tr>' + l1 + '</tr>'
                        + '<tr>' + l2 + '</tr>'
                        + '<tr>' + l3 + '</tr>'
                        + '<tr>' + l4 + '</tr>'
                        + '<tr>' + l5 + '</tr>'
                        + '<tr>' + l6 + '</tr>'
                        +'</tbody>'
                        + '</table>'
                return construct
                
            }

            $(function() {
                $('#ptable').bootstrapTable()
                $('#stable').bootstrapTable()
            })
    
        </script>
    </body>
</html>